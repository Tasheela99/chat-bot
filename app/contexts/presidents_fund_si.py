import difflib
import re

def get_faq_answer(user_question: str) -> str:
    """
    Returns the best matching FAQ answer for a user's question.
    Uses both exact matching and keyword-based context matching.
    """
    faqs = CONTEXT["faqs"]
    user_question_lower = user_question.lower()
    
    # First try exact match using difflib
    questions = [faq["question"] for faq in faqs]
    match = difflib.get_close_matches(user_question, questions, n=1, cutoff=0.6)
    if match:
        for faq in faqs:
            if faq["question"] == match[0]:
                if "answer" in faq:
                    return faq["answer"]
                elif "answers" in faq:
                    return faq["answers"][0]
    
    # If no exact match, try keyword-based matching and generate contextual answers
    return get_contextual_answer(user_question_lower)

def get_contextual_answer(user_question: str) -> str:
    """
    Generate contextual answers based on keywords and FAQ content in Sinhala
    """
    # Define keyword mappings to relevant information in Sinhala
    keyword_patterns = {
        "අයදුම්|ගන්න|කරන්නේ|කරමු|කරන්න": {
            "answer": "ජනාධිපති අරමුදලෙන් වෛද්‍ය ආධාර සඳහා අයදුම් කිරීම: 1) වෙබ් අඩවිය හරහා (www.presidentsfund.gov.lk), 2) WhatsApp හරහා (0740854527), 3) ආසන්නතම ප්‍රාදේශීය ලේකම් කාර්යාලය, 4) ජනාධිපති අරමුදල් කාර්යාලයට, හෝ 5) තැපැල් ලිපියක් යැවීමෙන්.",
        },
        "සුදුසුකම්|හැකියාව|කවුරු|අයදුම් කරන්න": {
            "answer": "සියලුම ශ්‍රී ලාංකික පුරවැසියන්ට ජනාධිපති අරමුදලෙන් වෛද්‍ය ආධාර සඳහා අයදුම් කිරීමට සුදුසුකම් ඇත, රජයේ නිලධාරීන් ඇතුළුව. පවුලේ සාමාජිකයන්ට රෝගියා වෙනුවෙන් අයදුම් කළ හැක. අවස්ථා තුනකදී අයදුම් කළ හැකි අතර උපරිම මිලියන 1ක් දක්වා ආධාර ලබා ගත හැක.",
        },
        "ලියකියවිලි|බිල්|රිසිට්|මුල්": {
            "answer": "ඔව්, වෛද්‍ය ආධාර සඳහා අයදුම් කිරීමේදී අදාළ වෛද්‍ය ආයතන විසින් නිකුත් කරන ලද සියලුම බිල්පත් සහ රිසිට්පත්වල මුල් පිටපත් ඉදිරිපත් කිරීම අනිවාර්ය වේ.",
        },
        "කාලය|දින|ශල්‍යකර්ම|පසු|කලින්": {
            "answer": "ශල්‍යකර්මය හෝ ප්‍රතිකාර වලින් පසු රෝහලෙන් නිදහස් වූ දිනයේ සිට දින 60ක් ඇතුළත අයදුම්පත්‍ර ඉදිරිපත් කළ හැක (සති අන්ත සහ රජයේ නිවාඩු ඇතුළුව). ශල්‍යකර්මයට පෙරව අයදුම් කිරීම අනිවාර්ය නොවේ.",
        },
        "ගෙවීම්|මුදල්|මුදල|වියදම": {
            "answer": "ජනාධිපති අරමුදල වෛද්‍ය ප්‍රතිකාර සඳහා අර්ධ මූල්‍ය ආධාර ලබා දෙයි. සම්පූර්ණ වියදම ආපසු ගෙවිය නොහැක. සියලුම ලියකියවිලි නිසි ලෙස ඉදිරිපත් කළහොත් ගෙවීම සාමාන්‍යයෙන් දින 3-5ක් ගතවේ.",
        },
        "රජයේ|රාජ්‍ය|රෝහල": {
            "answer": "රාජ්‍ය රෝහල්වල සිදු කරන ශල්‍යකර්ම සඳහා කිසිදු ගෙවීමක් නොකරනු ලැබේ මේවා නොමිලේ බැවිනි. කෙසේවෙතත්, අනුමත රෝගවල ලැයිස්තුව සහ වෙනත් ආයතනවලින් උපකරණ මිලදී ගැනීම සඳහා අනුමත විධිවිධාන අනුව අයදුම්පත්‍ර ඉදිරිපත් කළ හැක.",
        },
        "රක්ෂණ|වෙනත්|ආයතන|ආගරහර": {
            "answer": "රක්ෂණ සමාගම් වැනි වෙනත් ආයතනවලින් ප්‍රතිපූරණය ලැබීම අයදුම් කිරීම සඳහා බාධකයක් නොවේ. කෙසේවෙතත්, ඒ ආයතන වෛද්‍ය වියදම්වලින් 50% හෝ ඊට වැඩි ප්‍රමාණයක් ආවරණය කළහොත් ජනාධිපති අරමුදල ආධාර ලබා නොදේ.",
        },
        "කාර්යාලය|කොළඹ|යන්න": {
            "answer": "කොළඹ කාර්යාලයට යාම අවශ්‍ය නැත. ඔබගේ ආසන්නතම ප්‍රාදේශීය ලේකම් කාර්යාලයට අයදුම්පත ඉදිරිපත් කළ හැකි බැවින් එය වඩාත් පහසුවකි.",
        },
        "රෝගියා|පවුල|කවුද": {
            "answer": "රෝගියා අයදුම්කරු විය යුතු නැත. පවුලේ සාමාජිකයෙකුට රෝගියා වෙනුවෙන් අයදුම් කළ හැකිය. පවුලේ සාමාජිකයෙකු නොමැති නම් ආසන්නතම ඥාතියෙකුට අයදුම් කළ හැක.",
        }
    }
    
    # Check for keyword matches
    for pattern, info in keyword_patterns.items():
        if re.search(pattern, user_question, re.IGNORECASE):
            return info["answer"]
    
    # If no keyword match, try to provide general guidance
    general_keywords = ["උදව්", "තොරතුරු", "ගැන", "මොනවද", "අරමුදල", "ආධාර", "වෛද්‍ය"]
    if any(keyword in user_question for keyword in general_keywords):
        return "ජනාධිපති අරමුදල ශ්‍රී ලාංකික පුරවැසියන්ට වෛද්‍ය ආධාර ලබා දෙයි. ඔබට වෙබ් අඩවිය (www.presidentsfund.gov.lk), WhatsApp (0740854527), හෝ ආසන්නතම ප්‍රාදේශීය ලේකම් කාර්යාලය හරහා අයදුම් කළ හැකිය. ප්‍රතිකාරයෙන් පසු දින 60ක් ඇතුළත අයදුම්පත් ඉදිරිපත් කළ හැකි අතර මුල් බිල්පත් සහ පවුලේ සාමාජික අයදුම් පිළිගත හැක."
    
    return "කණගාටුයි, ඔබගේ ප්‍රශ්නය පිළිබඳ නිශ්චිත තොරතුරු සොයා ගත නොහැකි විය. විස්තරාත්මක උපදෙස් සඳහා කරුණාකර ජනාධිපති අරමුදලේ හොට්ලයින් +94-11-2354354 අමතන්න."

CONTEXT = {
    "system_prompt": "ඔබ ශ්‍රී ලංකා ජනාධිපති අරමුදල සඳහා AI උදව්කරු වේ. ඔබේ කාර්යය වන්නේ වෛද්‍ය ආධාර, සුදුසුකම් සහ අයදුම් ක්‍රියාවලිය පිළිබඳ නිවැරදි තොරතුරු ලබා දීමයි.",
    "context_info": "වෛද්‍ය ආධාර සඳහා අයදුම් කිරීම, සුදුසුකම් සහ අයදුම් ක්‍රියාවලිය පිළිබඳ වඩාත්ම පොදු ප්‍රශ්න වලට පිළිතුරු සොයා ගන්න.",
    "faqs": [
        {"question": "ජනාධිපති අරමුදලෙන් වෛද්‍ය ආධාර ලබා ගැනීම සඳහා අයදුම්කරුවන් කොළඹ කාර්යාලයට පැමිණිය යුතුද?", "answer": "නැත, අයදුම්කරුවන්ට දැන් ඔවුන්ගේ අයදුම්පත්‍ර ආසන්නතම ප්‍රාදේශීය ලේකම් කාර්යාලයට ඉදිරිපත් කළ හැක"},
        {"question": "අයදුම්පත්‍රයක් ලබා ගන්නේ කෙසේද?", "answers": ["ජනාධිපති අරමුදලේ වෙබ් අඩවිය හරහා (www.presidentsfund.gov.lk)", "Whatsapp හරහා (Whatsapp අංක 0740854527 ට පණිවිඩයක් යැවීමෙන්)", "ආසන්නතම ප්‍රාදේශීය ලේකම් කාර්යාලයට පැමිණීමෙන්", "ජනාධිපති අරමුදලට පැමිණීමෙන්", "තැපැල් හරහා (ජනාධිපති අරමුදලට ඉල්ලීම් ලිපියක් යැවීමෙන්)"]},
        {"question": "රෝගියා අයදුම්කරු විය යුතුද?", "answers": ["නැත, රෝගියා වෙනුවෙන් පවුලේ සාමාජිකයෙකුට අයදුම් කළ හැක", "නියෝජනය කිරීමට පවුලේ සාමාජිකයෙකු නොමැති අවස්ථාවේ, ආසන්නතම ඥාතියෙකුට රෝගියා වෙනුවෙන් අයදුම් කළ හැක"]},
        {"question": "ශල්‍යකර්මයට පෙර පමණක් අයදුම් කළ හැකිද?", "answer": "නැත, ශල්‍යකර්මය හෝ ප්‍රතිකාර වලින් පසු රෝහලෙන් නිදහස් වූ දිනයේ සිට දින 60ක් ඇතුළත අයදුම්පත්‍ර ඉදිරිපත් කළ හැක (සති අන්ත සහ රජයේ නිවාඩු ඇතුළුව)"},
        {"question": "ශල්‍යකර්මය සඳහා වියදම් කළ සම්පූර්ණ මුදල ආපසු ගෙවිය හැකිද?", "answer": "නැත, ශල්‍යකර්මය හෝ ප්‍රතිකාර සඳහා ලබා දෙන මුදල පිළිබඳ වැඩි විස්තර සඳහා කරුණාකර මෙම සබැඳිය බලන්න"},
        {"question": "අයදුම් කිරීමේදී බිල්පත්වල මුල් පිටපත් ඉදිරිපත් කිරීම අනිවාර්යයද?", "answer": "ඔව්, වෛද්‍ය ආධාර සඳහා අයදුම් කිරීමේදී අදාළ ආයතන විසින් නිකුත් කරන ලද බිල්පත් සහ රිසිට්පත්වල මුල් පිටපත් ඉදිරිපත් කිරීම අනිවාර්ය වේ"},
        {"question": "වෙනත් ආයතනවලින් ප්‍රතිපූරණය ලැබීමේ අවස්ථාවේදී වෛද්‍ය ආධාර සඳහා අයදුම් කළ හැකිද?", "answers": ["වෙනත් ආයතනවලින් ප්‍රතිපූරණය ලැබීම (උදා: ආගරහර, රක්ෂණ සමාගම) අයදුම් කිරීම සඳහා බාධකයක් නොවේ", "ශල්‍යකර්මය හෝ ප්‍රතිකාර වියදම්වලට අදාළව එවැනි ආයතනවලින් වෛද්‍ය වියදම්වලින් 50% ක් හෝ ඊට වැඩි ප්‍රමාණයක් ආවරණය වන අවස්ථාවේ ජනාධිපති අරමුදල වෛද්‍ය ආධාර ලබා නොදේ"]},
        {"question": "රජයේ නිලධාරීන්ට අයදුම්පත්‍ර ඉදිරිපත් කිරීමට සුදුසුකම් නැද්ද?", "answer": "නැත, රජයේ නිලධාරීන්ටත් ජනාධිපති අරමුදලෙන් වෛද්‍ය ආධාර සඳහා අයදුම් කිරීමට සුදුසුකම් ඇත"},
        {"question": "වරක් වෛද්‍ය ආධාර ලබාගත් අයදුම්කරුවෙකුට නැවත අයදුම් කිරීමට සුදුසුකම් තිබේද?", "answer": "ඔව්, අවස්ථා තුනකදී අයදුම් කළ හැකි අතර උපරිම මිලියන 1 ක් දක්වා වෛද්‍ය ආධාර ලබා ගත හැක"},
        {"question": "රාජ්‍ය රෝහල්වල සිදු කරන ශල්‍යකර්ම සඳහා අයදුම්පත්‍ර ඉදිරිපත් කළ හැකිද?", "answers": ["නැත, රාජ්‍ය රෝහල්වල සිදු කරන ශල්‍යකර්ම සඳහා කිසිදු ගෙවීමක් නොකරනු ලැබේ", "අනුමත රෝග ලැයිස්තුවේ දක්වා ඇති රාජ්‍ය රෝහල්වල රෝග ලැයිස්තුව සහ වෙනත් ආයතනවලින් උපකරණ මිලදී ගැනීම සඳහා අනුමත විධිවිධාන අනුව අයදුම්පත්‍ර ඉදිරිපත් කළ හැක"]},
        {"question": "ගෙවීම් කිරීමට කොපමණ කාලයක් ගතවේද?", "answer": "වෙනත් විශේෂ හේතුවක් නොමැති නම් සහ රෝගියා සියලුම ලියකියවිලි සහිතව අයදුම්පත නිසි ලෙස ඉදිරිපත් කර ඇත්නම්, ගෙවීම් කාල සීමාව දින 3 සිට 5 දක්වා විය හැක"},
        {"question": "රෝගියා මරණයට පත් වුවහොත් හෝ නිශ්චල වුවහොත් කාටද ගෙවනු ලැබේ?", "answer": "ප්‍රාදේශීය හෝ දිස්ත්‍රික් ලේකම්වරයාගේ නිර්දේශය සමඟ විස්තීර්ණ වාර්තාවක් ලබා ගැනීමෙන් පසුව තීරණයක් ගනු ලැබේ"}
    ]
}
