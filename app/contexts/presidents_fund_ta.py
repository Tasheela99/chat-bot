import difflib
import re

def get_faq_answer(user_question: str) -> str:
    """
    Returns the best matching FAQ answer for a user's question.
    Uses both exact matching and keyword-based context matching.
    """
    faqs = CONTEXT["faqs"]
    user_question_lower = user_question.lower()
    
    # First try exact match using difflib
    questions = [faq["question"] for faq in faqs]
    match = difflib.get_close_matches(user_question, questions, n=1, cutoff=0.6)
    if match:
        for faq in faqs:
            if faq["question"] == match[0]:
                if "answer" in faq:
                    return faq["answer"]
                elif "answers" in faq:
                    return faq["answers"][0]
    
    # If no exact match, try keyword-based matching and generate contextual answers
    return get_contextual_answer(user_question_lower)

def get_contextual_answer(user_question: str) -> str:
    """
    Generate contextual answers based on keywords and FAQ content in Tamil
    """
    # Define keyword mappings to relevant information in Tamil
    keyword_patterns = {
        "விண்ணப்பம்|எப்படி|கிடைக்கும்|செய்வது": {
            "answer": "ஜனாதிபதி நிதியத்திலிருந்து மருத்துவ உதவிக்கு விண்ணப்பிக்க: 1) இணையதளம் மூலம் (www.presidentsfund.gov.lk), 2) WhatsApp மூலம் (0740854527), 3) அருகிலுள்ள பிரதேச செயலாளர் அலுவலகம், 4) ஜனாதிபதி நிதி அலுவலகத்திற்கு, அல்லது 5) அஞ்சல் கடிதம் அனுப்புவதன் மூலம்.",
        },
        "தகுதி|யார்|விண்ணப்பிக்க": {
            "answer": "அனைத்து இலங்கை குடிமக்களும் ஜனாதிபதி நிதியத்திலிருந்து மருத்துவ உதவிக்கு விண்ணப்பிக்க தகுதியுடையவர்கள், அரசு அலுவலர்கள் உட்பட. குடும்ப உறுப்பினர்கள் நோயாளிக்காக விண்ணப்பிக்க முடியும். மூன்று முறை விண்ணப்பிக்க முடியும் மற்றும் அதிகபட்சம் 1 மில்லியன் வரை உதவி பெற முடியும்.",
        },
        "ஆவணங்கள்|பில்|ரசீது|அசல்": {
            "answer": "ஆம், மருத்துவ உதவிக்கு விண்ணப்பிக்கும்போது தொடர்புடைய மருத்துவ நிறுவனங்களால் வழங்கப்பட்ட அனைத்து பில்கள் மற்றும் ரசீதுகளின் அசல் நகல்களை சமர்ப்பிப்பது கட்டாயமாகும்.",
        },
        "நேரம்|நாட்கள்|அறுவை|பிறகு|முன்": {
            "answer": "அறுவை சிகிச்சை அல்லது சிகிச்சைக்குப் பிறகு மருத்துவமனையிலிருந்து வெளியேறிய தேதியிலிருந்து 60 நாட்களுக்குள் விண்ணப்பங்களை சமர்ப்பிக்க முடியும் (வார இறுதி நாட்கள் மற்றும் பொது விடுமுறை நாட்கள் உட்பட). அறுவை சிகிச்சைக்கு முன்பு விண்ணப்பிப்பது அவசியமில்லை.",
        },
        "பணம்|தொகை|செலவு|திருப்பி": {
            "answer": "ஜனாதிபதி நிதியம் மருத்துவ சிகிச்சைகளுக்கு பகுதி நிதி உதவி வழங்குகிறது. முழு தொகையையும் திருப்பிச் செலுத்த முடியாது. அனைத்து ஆவணங்களும் சரியாக சமர்ப்பிக்கப்பட்டால் பணம் செலுத்துதல் பொதுவாக 3-5 நாட்கள் ஆகும்.",
        },
        "அரசு|பொது|மருத்துவமனை": {
            "answer": "அரசு மருத்துவமனைகளில் நடத்தப்படும் அறுவை சிகிச்சைகளுக்கு எந்த பணமும் செலுத்தப்படாது, ஏனெனில் இவை இலவசம். இருப்பினும், அனுமதிக்கப்பட்ட நோய்களின் பட்டியல் மற்றும் பிற நிறுவனங்களிலிருந்து உபகரணங்களை வாங்குவதற்கு அனுமதிக்கப்பட்ட விதிமுறைகளின்படி விண்ணப்பங்களை சமர்ப்பிக்க முடியும்.",
        },
        "காப்பீடு|மற்ற|நிறுவனங்கள்|ஆக்ரஹார": {
            "answer": "காப்பீட்டு நிறுவனங்கள் போன்ற பிற நிறுவனங்களிலிருந்து திருப்பிச் செலுத்துதல் பெறுவது விண்ணப்பிப்பதற்கு தடையாக இல்லை. இருப்பினும், அந்த நிறுவனங்கள் மருத்துவ செலவுகளில் 50% அல்லது அதற்கு மேற்பட்டவற்றை ஈடுசெய்தால் ஜனாதிபதி நிதியம் உதவி வழங்காது.",
        },
        "அலுவலகம்|கொழும்பு|வர": {
            "answer": "கொழும்பு அலுவலகத்திற்கு வர வேண்டியதில்லை. உங்கள் அருகிலுள்ள பிரதேச செயலாளர் அலுவலகத்தில் விண்ணப்பத்தை சமர்ப்பிக்க முடியும், இது மிகவும் வசதியானது.",
        },
        "நோயாளி|குடும்பம்|யார்": {
            "answer": "நோயாளி விண்ணப்பதாரராக இருக்க வேண்டியதில்லை. குடும்ப உறுப்பினர் ஒருவர் நோயாளிக்காக விண்ணப்பிக்க முடியும். குடும்ப உறுப்பினர் யாரும் இல்லாவிட்டால் நெருங்கிய உறவினர் ஒருவர் விண்ணப்பிக்க முடியும்.",
        }
    }
    
    # Check for keyword matches
    for pattern, info in keyword_patterns.items():
        if re.search(pattern, user_question, re.IGNORECASE):
            return info["answer"]
    
    # If no keyword match, try to provide general guidance
    general_keywords = ["உதவி", "தகவல்", "பற்றி", "என்ன", "நிதி", "உதவி", "மருத்துவ"]
    if any(keyword in user_question for keyword in general_keywords):
        return "ஜனாதிபதி நிதியம் இலங்கை குடிமக்களுக்கு மருத்துவ உதவி வழங்குகிறது. நீங்கள் இணையதளம் (www.presidentsfund.gov.lk), WhatsApp (0740854527), அல்லது அருகிலுள்ள பிரதேச செயலாளர் அலுவலகம் மூலம் விண்ணப்பிக்க முடியும். சிகிச்சைக்குப் பிறகு 60 நாட்களுக்குள் விண்ணப்பங்களை சமர்ப்பிக்க முடியும் மற்றும் அசல் பில்கள் மற்றும் குடும்ப உறுப்பினர் விண்ணப்பங்கள் ஏற்றுக்கொள்ளப்படும்."
    
    return "மன்னிக்கவும், உங்கள் கேள்வி பற்றிய குறிப்பிட்ட தகவலை கண்டுபிடிக்க முடியவில்லை. விரிவான உதவிக்கு ஜனாதிபதி நிதி ஹாட்லைன் +94-11-2354354 ஐ அழைக்கவும்."

CONTEXT = {
    "system_prompt": "நீங்கள் இலங்கை ஜனாதிபதி நிதிக்கான AI உதவியாளர். உங்கள் பணி மருத்துவ உதவி, தகுதி மற்றும் விண்ணப்ப செயல்முறை பற்றிய சரியான தகவலை வழங்குவது.",
    "context_info": "மருத்துவ உதவிக்கு விண்ணப்பித்தல், தகுதிகள் மற்றும் விண்ணப்ப நடைமுறைகள் பற்றிய மிகவும் பொதுவான கேள்விகளுக்கான பதில்களைக் கண்டறியுங்கள்.",
    "faqs": [
        {"question": "ஜனாதிபதி நிதியத்திலிருந்து மருத்துவ உதவி பெறுவதற்காக விண்ணப்பதாரர்கள் கொழும்பு அலுவலகத்திற்கு வர வேண்டுமா?", "answer": "இல்லை, விண்ணப்பதாரர்கள் இப்போது அவர்களுடைய விண்ணப்பங்களை அருகிலுள்ள பிரதேச செயலாளர் அலுவலகத்தில் சமர்ப்பிக்க முடியும்"},
        {"question": "விண்ணப்பத்தை எப்படி பெறுவது?", "answers": ["ஜனாதிபதி நிதியத்தின் இணையதளம் மூலம் (www.presidentsfund.gov.lk)", "Whatsapp மூலம் (Whatsapp எண் 0740854527 க்கு செய்தி அனுப்புவதன் மூலம்)", "அருகிலுள்ள பிரதேச செயலாளர் அலுவலகத்திற்கு வருவதன் மூலம்", "ஜனாதிபதி நிதியத்திற்கு வருவதன் மூலம்", "அஞ்சல் மூலம் (ஜனாதிபதி நிதியத்திற்கு கோரிக்கை கடிதம் அனுப்புவதன் மூலம்)"]},
        {"question": "நோயாளி விண்ணப்பதாரராக இருக்க வேண்டுமா?", "answers": ["இல்லை, நோயாளிக்கு பதிலாக குடும்ப உறுப்பினர் ஒருவர் விண்ணப்பிக்க முடியும்", "பிரதிநிதித்துவப்படுத்த குடும்ப உறுப்பினர் யாரும் இல்லாத நிலையில், நெருங்கிய உறவினர் ஒருவர் நோயாளிக்காக விண்ணப்பிக்க முடியும்"]},
        {"question": "அறுவை சிகிச்சைக்கு முன்பு மட்டுமே விண்ணப்பம் செய்ய முடியுமா?", "answer": "இல்லை, அறுவை சிகிச்சை அல்லது சிகிச்சைக்குப் பிறகு மருத்துவமனையிலிருந்து வெளியேறிய தேதியிலிருந்து 60 நாட்களுக்குள் விண்ணப்பங்களை சமர்ப்பிக்க முடியும் (வார இறுதி நாட்கள் மற்றும் பொது விடுமுறை நாட்கள் உட்பட)"},
        {"question": "அறுவை சிகிச்சைக்கு செலவழித்த மொத்த தொகையையும் திருப்பிச் செலுத்த முடியுமா?", "answer": "இல்லை, அறுவை சிகிச்சை அல்லது சிகிச்சைக்காக வழங்கப்படும் தொகை பற்றிய மேலும் விவரங்களுக்கு இந்த இணைப்பைப் பார்க்கவும்"},
        {"question": "விண்ணப்பிக்கும்போது பில்களின் அசல் நகல்களை சமர்ப்பிக்க வேண்டுமா?", "answer": "ஆம், மருத்துவ உதவிக்கு விண்ணப்பிக்கும்போது தொடர்புடைய நிறுவனங்களால் வழங்கப்பட்ட பில்கள் மற்றும் ரசீதுகளின் அசல் நகல்களை சமர்ப்பிப்பது கட்டாயமாகும்"},
        {"question": "மற்ற நிறுவனங்களிலிருந்து திருப்பிச் செலுத்தப்படும் நிலையில் மருத்துவ உதவிக்கு விண்ணப்பிக்க முடியுமா?", "answers": ["மற்ற நிறுவனங்களிலிருந்து திருப்பிச் செலுத்துதல் (எ.கா: ஆக்ரஹார, காப்பீட்டு நிறுவனம்) விண்ணப்பிப்பதற்கு தடையாக இல்லை", "அறுவை சிகிச்சை அல்லது சிகிச்சை செலவுகளுக்கு தொடர்பாக அத்தகைய நிறுவனங்களிலிருந்து மருத்துவ செலவுகளில் 50% அல்லது அதற்கு மேற்பட்டவற்றை ஈடுசெய்யும் நிலையில் ஜனாதிபதி நிதியம் மருத்துவ உதவியை வழங்காது"]},
        {"question": "பொது அலுவலர்கள் விண்ணப்பங்களை சமர்ப்பிக்க தகுதியற்றவர்களா?", "answer": "இல்லை, பொது அலுவலர்கள் கூட ஜனாதிபதி நிதியத்திலிருந்து மருத்துவ உதவிக்கு விண்ணப்பிக்க தகுதியுடையவர்கள்"},
        {"question": "ஒருமுறை மருத்துவ உதவி பெற்ற விண்ணப்பதாரர் மீண்டும் விண்ணப்பிக்க தகுதியுடையவரா?", "answer": "ஆம், மூன்று நிகழ்வுகளில் விண்ணப்பம் செய்ய முடியும் மற்றும் அதிகபட்சம் 1 மில்லியன் வரை மருத்துவ உதவி பெற முடியும்"},
        {"question": "அரசு மருத்துவமனைகளில் நடத்தப்படும் அறுவை சிகிச்சைகளுக்கு விண்ணப்பம் செய்ய முடியுமா?", "answers": ["இல்லை, அரசு மருத்துவமனைகளில் நடத்தப்படும் அறுவை சிகிச்சைகளுக்கு எந்த பணமும் செலுத்தப்படாது", "அரசு மருத்துவமனைகளில் குறிப்பிடப்பட்ட நோய்கள் பட்டியல் மற்றும் பிற நிறுவனங்களிலிருந்து உபகரணங்களை வாங்குவதற்கு அனுமதிக்கப்பட்ட நோய்கள் பட்டியலில் அனுமதிக்கப்பட்ட விதிமுறைகளுக்கு உட்பட்டு விண்ணப்பங்களை சமர்ப்பிக்க முடியும்"]},
        {"question": "பணம் செலுத்துவதற்கு எவ்வளவு நேரம் ஆகும்?", "answer": "வேறு எந்த சிறப்பு காரணமும் இல்லாமல், நோயாளி அனைத்து ஆவணங்களுடன் விண்ணப்பத்தை சரியாக சமர்ப்பித்திருந்தால், பணம் செலுத்தும் காலம் சுமார் 3 முதல் 5 நாட்கள் இருக்கலாம்"},
        {"question": "நோயாளி இறந்துவிட்டால் அல்லது அசையமுடியாத நிலையில் இருந்தால் யாருக்கு பணம் செலுத்தப்படும்?", "answer": "பிரதேச அல்லது மாவட்ட செயலாளரின் பரிந்துரையுடன் விரிவான அறிக்கையைப் பெற்ற பிறகு தீர்மானம் எடுக்கப்படுகிறது"}
    ]
}
